var fs = require('fs')
var path = require('path')
var prototype = require('./prototype')

var ram = {}

var rootPath = __dirname + '/db'
var rootPathSetted = false

prototype.__proto__ = Array.prototype

exports.get = function get(name, type){

  var filePath = path.join(rootPath, name + '.json')
  type = type || Array
  var array = ram[filePath]

  // 如果array不存在
  if(!array){

    var array
    try{
      array = require(filePath)
    }catch(e){ // file not existed
      if(type === Array){
        array = []
      }else{
        array = {}
      }
    }

    if(type === Array){
      array.__proto__ = prototype
    }

    array.save = function(observes){
      fs.writeFile(filePath, JSON.stringify(array))
    }

    Object.observe(array, array.save.bind(array))

    ram[filePath] = array
  }

  return array
}

exports.path = function(path) {
  if (rootPathSetted && path !== rootPath) {
    throw new Error('path has been set to ' + rootPath)
  }

  rootPathSetted = true
  rootPath = path
}
